<!DOCTYPE html>
<html lang="english" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Automatic Differentiation for Power System Analysis - Michael Jurasovic</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="./automatic-differentiation-for-power-system-analysis.html">

        <meta name="author" content="Michael Jurasovic" />
        <meta name="description" content="This notebook calculates marginal loss factors of a power system using automatic differentiation. The marginal loss factor (MLF) at a connection node is defined as the rate of change of system generation at the reference node with respect to the change in load at the connection node. The reference node …" />

        <meta property="og:site_name" content="Michael Jurasovic" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Automatic Differentiation for Power System Analysis"/>
        <meta property="og:url" content="./automatic-differentiation-for-power-system-analysis.html"/>
        <meta property="og:description" content="This notebook calculates marginal loss factors of a power system using automatic differentiation. The marginal loss factor (MLF) at a connection node is defined as the rate of change of system generation at the reference node with respect to the change in load at the connection node. The reference node …"/>
        <meta property="article:published_time" content="2010-12-03" />
            <meta property="article:section" content="misc" />
            <meta property="article:author" content="Michael Jurasovic" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.yeti.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/autumn.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>
        <link href="./static/css/custom.css" rel="stylesheet">

        <link href="./feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Michael Jurasovic ATOM Feed"/>


</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
Michael Jurasovic            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="https://github.com/jurasofish">Github</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-md-8 col-md-offset-2">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./automatic-differentiation-for-power-system-analysis.html"
                       rel="bookmark"
                       title="Permalink to Automatic Differentiation for Power System Analysis">
                        Automatic Differentiation for Power System Analysis
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <time datetime="2010-12-03T10:20:00+11:00"> Fri 03 December 2010</time>
                    by
                    <a href="./author/michael-jurasovic.html"> Michael Jurasovic</a>
                    <br><br>
                </div>
                <p><em>This notebook calculates marginal loss factors of a power system using automatic differentiation.</em></p>
<p>The marginal loss factor (MLF) at a connection node is defined as the rate of change of system generation at the reference node with respect to the change in load at the connection node. The reference node is defined arbitrarily.
That is, an MLF of &gt;1 indicates that system losses as a ratio of total system load increase when load is added at that node.</p>
<p>Clearly, this can be approximately calculated by placing all slack generation at the reference node and slightly changing the load at the connection node.</p>
<p>However, if we represent the loads at all nodes of the system as a vector then we can write a simple function <span class="math">\(P_{slack} = f(\vec{P}_{load})\)</span> which takes as input the change to the power system loads (as a vector) and returns the resulting total slack bus power injection. <strong>The gradient of this function will be the marginal loss factors of all nodes.</strong></p>
<h2>This Notebook</h2>
<p>Below is code for calculating MLFs both using finite differences and through automatic differentiation with a custom Gauss-Seidel power flow implementation. A custom implementation is required to make it compatible with the <code>autograd</code> package.</p>
<p>Hopefully the Gauss-Seidel implementation is a useful standalone reference as a fairly compact numpy based implementation. I've found it's hard to find simple Python implementations. Note that it will probably fall apart if you put unexpected things in the pandapower network like constant impedance loads or buses that aren't numbered contiguously 0 through n.</p>
<p>To use this notebook first <code>pip install -r requirements.txt</code></p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandapower</span> <span class="k">as</span> <span class="nn">pp</span>
<span class="kn">import</span> <span class="nn">pandapower.networks</span> <span class="k">as</span> <span class="nn">ppnw</span>
<span class="kn">import</span> <span class="nn">autograd.numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">autograd</span> <span class="kn">import</span> <span class="n">grad</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">formatter</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;complexfloat&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                               <span class="s1">&#39;float_kind&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)})</span>
</pre></div>


<h1>I. Finite Differences</h1>
<p>To start with, MLFs can be calculated using a simple finite differences approach.
This simple approach serves as a baseline to establish what the expected results are.</p>
<p>Notably what we see is that bus 0 has an MLF of 1, because it's the slack bus.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fin_diff</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Finite difference approximation of grad of function f. From JAX docs. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">eps</span><span class="o">*</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">eps</span><span class="o">*</span><span class="n">v</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">eps</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))])</span>


<span class="k">def</span> <span class="nf">run_lf_pp</span><span class="p">(</span><span class="n">load_p</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;nr&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate total slack generation with given load power changes.</span>

<span class="sd">    Args:</span>
<span class="sd">        load_p (iterable): Iterable of additional loads to add to network.</span>
<span class="sd">            Index i will add load to bus i.</span>
<span class="sd">        net (pp.Network):</span>
<span class="sd">        algorithm (str): Algorithm to pass to pandapower solver.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Sum of real power injected by slack buses in the network.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
    <span class="n">pd2ppc</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">_pd2ppc_lookups</span><span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">]</span>  <span class="c1"># Pandas bus num --&gt; internal bus num.</span>
    <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">extra_p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">load_p</span><span class="p">):</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">create_load</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd2ppc</span> <span class="o">==</span> <span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">extra_p</span><span class="p">)</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">runpp</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">net</span><span class="o">.</span><span class="n">res_ext_grid</span><span class="p">[</span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mlf_fin_diff</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">runpp</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
    <span class="n">load_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">mlfs</span> <span class="o">=</span> <span class="n">fin_diff</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">run_lf_pp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="s1">&#39;nr&#39;</span><span class="p">),</span> <span class="n">load_p</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MLFs at each node calculated using pandapower with finite differences.&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mlfs</span><span class="p">)</span>
<span class="n">mlf_fin_diff</span><span class="p">(</span><span class="n">ppnw</span><span class="o">.</span><span class="n">case9</span><span class="p">())</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">MLFs at each node calculated using pandapower with finite differences.</span>
<span class="err">[1.000 0.952 0.961 1.000 1.011 0.961 0.966 0.952 1.010]</span>
</pre></div>


<h1>II. Automatic Differentiation</h1>
<p>Here we define methods to perform a Guass-Seidel load flow using a pandapower network as the starting point.
The network structure is pulled from the pandapower network, as well as the pre-constructed ybus.</p>
<p>The Gauss-Seidel implementation is written to make it compatible with the <code>autograd</code> library.
The main restriction is ensuring that assignment into arrays is not performed.
e.g. <code>x = np.array([...]); x[1] = 2</code> is not permitted, as this is assigning the a value into the array.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init_v</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pd2ppc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Initial bus voltage vector using generator voltage setpoints or 1j+0pu. &quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">v</span><span class="p">[</span><span class="n">pd2ppc</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">bus</span><span class="p">]]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">vm_pu</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">ext_grid</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">v</span><span class="p">[</span><span class="n">pd2ppc</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">bus</span><span class="p">]]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">vm_pu</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">va_degree</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scheduled_p_q</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pd2ppc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return known per unit real and reactive power injected at each bus.</span>
<span class="sd">    Does not include slack real/reactive powers nor PV gen reactive power.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">psch</span><span class="p">,</span> <span class="n">qsch</span> <span class="o">=</span> <span class="p">{</span><span class="n">b</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)},</span> <span class="p">{</span><span class="n">b</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)}</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">psch</span><span class="p">[</span><span class="n">pd2ppc</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">bus</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">p_mw</span> <span class="o">/</span> <span class="n">net</span><span class="o">.</span><span class="n">sn_mva</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">sgen</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">psch</span><span class="p">[</span><span class="n">pd2ppc</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">bus</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">p_mw</span> <span class="o">/</span> <span class="n">net</span><span class="o">.</span><span class="n">sn_mva</span>
        <span class="n">qsch</span><span class="p">[</span><span class="n">pd2ppc</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">bus</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">q_mvar</span> <span class="o">/</span> <span class="n">net</span><span class="o">.</span><span class="n">sn_mva</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">psch</span><span class="p">[</span><span class="n">pd2ppc</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">bus</span><span class="p">]]</span> <span class="o">-=</span> <span class="n">r</span><span class="o">.</span><span class="n">p_mw</span> <span class="o">/</span> <span class="n">net</span><span class="o">.</span><span class="n">sn_mva</span>
        <span class="n">qsch</span><span class="p">[</span><span class="n">pd2ppc</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">bus</span><span class="p">]]</span> <span class="o">-=</span> <span class="n">r</span><span class="o">.</span><span class="n">q_mvar</span> <span class="o">/</span> <span class="n">net</span><span class="o">.</span><span class="n">sn_mva</span>
    <span class="k">return</span> <span class="n">psch</span><span class="p">,</span> <span class="n">qsch</span>


<span class="k">def</span> <span class="nf">run_lf</span><span class="p">(</span><span class="n">load_p</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">comp_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Perform Gauss-Seidel power flow on the given pandapower network.</span>

<span class="sd">    The ``load_p`` array is an iterable of additional real power load to add</span>
<span class="sd">    to each bus. By providing this as an input, this python function becomes</span>
<span class="sd">    the function ``slack_power = f(load_power)`` and thus the derivative of</span>
<span class="sd">    slack power with respect to load power can be calculated.</span>

<span class="sd">    By restricting the values of `load_p` to be very small we can ensure that</span>
<span class="sd">    this function is solving the load flow correctly by comparing it to the</span>
<span class="sd">    results in the pandapower network. Restricting to very small does not interfere</span>
<span class="sd">    with calculation of the derivative - that is, the derivative of</span>
<span class="sd">    x (the small value given as input) plus a constant (the load power specified</span>
<span class="sd">    in the pandapower network object) is equal to the derivative of x alone.</span>

<span class="sd">    Args:</span>
<span class="sd">        load_p (iterable): Iterable of very small values.</span>
<span class="sd">            Really, the power flow will work with non-zero but the consistency</span>
<span class="sd">            assertion with pandapower will fail.</span>
<span class="sd">        net (pp.Network): Solved Pandapower network object that defines the</span>
<span class="sd">            elements of the network and contains the ybus matrix.</span>
<span class="sd">        tol (float): Convergence tolerance (voltage).</span>
<span class="sd">        comp_tol (float): Tolerance for comparison check against pandapower.</span>
<span class="sd">        max_iter(int): Max iterations to solve load flow.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Sum of real power injected by slack buses in the network.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ybus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">_ppc</span><span class="p">[</span><span class="s2">&quot;internal&quot;</span><span class="p">][</span><span class="s2">&quot;Ybus&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">todense</span><span class="p">())</span>
    <span class="n">pd2ppc</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">_pd2ppc_lookups</span><span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">]</span>  <span class="c1"># Pandas bus num --&gt; internal bus num.</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">ybus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Number of buses.</span>
    <span class="n">slack_buses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pd2ppc</span><span class="p">[</span><span class="n">net</span><span class="o">.</span><span class="n">ext_grid</span><span class="p">[</span><span class="s1">&#39;bus&#39;</span><span class="p">]])</span>
    <span class="n">gen_buses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">pd2ppc</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">gen</span><span class="p">[</span><span class="s1">&#39;bus&#39;</span><span class="p">]])</span>
    <span class="n">ybus_hollow</span> <span class="o">=</span> <span class="n">ybus</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>  <span class="c1"># ybus with diagonal elements zeroed.</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">init_v</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pd2ppc</span><span class="p">)</span>
    <span class="n">psch</span><span class="p">,</span> <span class="n">qsch</span> <span class="o">=</span> <span class="n">scheduled_p_q</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pd2ppc</span><span class="p">)</span>
    <span class="c1"># Incorporate the variables we are differentiating with respect to:</span>
    <span class="n">psch</span> <span class="o">=</span> <span class="p">{</span><span class="n">b</span><span class="p">:</span> <span class="n">p</span> <span class="o">-</span> <span class="n">load_p</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psch</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>
        <span class="n">old_v</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slack_buses</span><span class="p">]:</span>
            <span class="n">qsch_b</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">old_v</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ybus</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">old_v</span><span class="p">))</span>
                      <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">gen_buses</span> <span class="k">else</span> <span class="n">qsch</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">ybus</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span> <span class="o">*</span> <span class="p">((</span><span class="n">psch</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">qsch_b</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">old_v</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                                     <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ybus_hollow</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">old_v</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">gen_buses</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">old_v</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>  <span class="c1"># Only use angle.</span>
        <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">old_v</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="n">p_slack</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ybus</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">v</span><span class="p">))</span> <span class="o">-</span> <span class="n">psch</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
                  <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">slack_buses</span><span class="p">)</span>
    <span class="c1"># Assert convergence and consistency with pandapower.</span>
    <span class="k">assert</span> <span class="n">it</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Load flow not converged in </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s1"> iterations.&#39;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">_ppc</span><span class="p">[</span><span class="s2">&quot;internal&quot;</span><span class="p">][</span><span class="s2">&quot;V&quot;</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="n">comp_tol</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>\
           <span class="sa">f</span><span class="s1">&#39;Voltage</span><span class="se">\n</span><span class="s1">pp:</span><span class="se">\t\t</span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">_ppc</span><span class="p">[</span><span class="s2">&quot;internal&quot;</span><span class="p">][</span><span class="s2">&quot;V&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">solved:</span><span class="se">\t</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_slack</span><span class="p">,</span> <span class="n">net</span><span class="o">.</span><span class="n">res_ext_grid</span><span class="p">[</span><span class="s1">&#39;p_mw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">atol</span><span class="o">=</span><span class="n">comp_tol</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>\
           <span class="sa">f</span><span class="s1">&#39;Slack Power</span><span class="se">\n</span><span class="s1">pp:</span><span class="se">\t\t</span><span class="si">{</span><span class="n">net</span><span class="o">.</span><span class="n">res_ext_grid</span><span class="p">[</span><span class="s2">&quot;p_mw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">solved:</span><span class="se">\t</span><span class="si">{</span><span class="n">p_slack</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">p_slack</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mlf_auto_diff</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">runpp</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>  <span class="c1"># Make sure network contains ybus and the solution values.</span>
    <span class="n">load_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">net</span><span class="o">.</span><span class="n">bus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">f_grad_p_slack</span> <span class="o">=</span> <span class="n">grad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">run_lf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">net</span><span class="p">))</span>
    <span class="n">mlfs</span> <span class="o">=</span> <span class="n">f_grad_p_slack</span><span class="p">(</span><span class="n">load_p</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MLFs at each node calculated using custom Guass-Seidel with automatic differentiation.&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mlfs</span><span class="p">)</span>
<span class="n">mlf_auto_diff</span><span class="p">(</span><span class="n">ppnw</span><span class="o">.</span><span class="n">case9</span><span class="p">())</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">MLFs at each node calculated using custom Guass-Seidel with automatic differentiation.</span>
<span class="err">[1.000 0.952 0.961 1.000 1.011 0.961 0.966 0.952 1.010]</span>
</pre></div>


<p>This works fine with larger networks too. The Gauss-Seidel implementation is by no means efficient though.</p>
<div class="highlight"><pre><span></span><span class="n">mlf_auto_diff</span><span class="p">(</span><span class="n">ppnw</span><span class="o">.</span><span class="n">case30</span><span class="p">())</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="err">MLFs at each node calculated using custom Guass-Seidel with automatic differentiation.</span>
<span class="err">[1.000 1.004 1.036 1.015 1.015 1.031 1.029 1.033 1.043 1.050 1.057 1.054</span>
<span class="err"> 1.019 1.041 1.037 1.011 1.033 1.026 1.045 1.014 1.026 1.043 1.063 1.022</span>
<span class="err"> 1.019 1.028 1.034 1.034 1.036 1.040]</span>
</pre></div>


<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jurasofish-github-io'; // required: replace example with your forum shortname

            var disqus_config = function () {
                this.language = "english";

                        this.page.identifier = '2010-12-03-automatic-differentiation-for-power-system-analysis';
                        this.page.url = './automatic-differentiation-for-power-system-analysis.html';
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <div class="row">
         <div class="col-md-8 col-md-offset-2">
            <hr>
            &copy; 2010 Michael Jurasovic
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>            <br><br>
         </div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jurasofish-github-io'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->


</body>
</html>